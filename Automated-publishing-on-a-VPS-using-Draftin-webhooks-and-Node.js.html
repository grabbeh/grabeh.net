<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>Grabeh.net</title>
  <link rel="stylesheet" href="https://unpkg.com/tachyons@4.7.0/css/tachyons.min.css" />
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,700" rel="stylesheet">
  <link href="https://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/styles/dracula.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/highlight.min.js"></script>
  <script>
    hljs.initHighlightingOnLoad()
  </script>
  <style>
    body {
      font-family: 'Roboto', serif;
    }

    .grey {
      color: rgba(0, 0, 0, .4)
    }
  </style>
</head>

<body class="bg-light-red" id="container">
  <div class="pa2 f5 bg-white mb4 tc w3 shadow-5">
    <a class="b link black underline-hover" href='/'><i class="fa fa-home fa-2x" aria-hidden="true"></i></a>
  </div>
  <div class="pl5-l pr5-l mh4-ns mh2">
    <div class="fl w-70-l w-100">
      <div class="cf shadow-5 mb3 pa3 bg-white">
        <div class="f2 b">Automated publishing on a VPS using Draftin webhooks and Node.js</div>
      </div>
      <div class="mb4-l shadow-5 bg-white ph5-ns ph3 pv1">
        <div class="f4-ns f5 w-100  lh-copy">
          <p>Draftin.com is a great tool I&#39;ve been using lately to do some writing. Whilst I&#39;m not utilising many of
            its more advanced features, the care and attention that its creator has put into the product shines through.</p>
          <p>Once I&#39;d written something my previous process of getting onto this site was to copy and paste the contents
            into a template file within the VPS I&#39;m using to host this blog, and then name it appropriately. Although
            this isn&#39;t a particularly burdensome process, I thought there may be a simpler process.</p>
          <p>Having a gander at Draftin I saw reference to <a href="https://draftin.com/features#webhooks">Webhooks</a>. Webhooks
            give you the ability to specify a url to which the content will be published using a simple POST request.</p>
          <p>I thought it would be interesting to try to integrate this into the VPS so you could post data and automatically
            create a html file in the folder from which the html files making up this blog are served from via Nginx.</p>
          <p>I initially created a basic Express server to test the data that was being sent. After some issues with accessing
            the data, I realised I need to parse the JSON to make it accessible. </p>
          <p>Once that was done, I wrote the &#39;content_html&#39; to a file in the relevant folder. However the issue was
            obviously that the only content being posted was the blog post itself. In addition to the content, it also needed
            surrounding container elements and the head element to specify css etc.</p>
          <p>To remedy this, I created a template.html file which is then read in when post data is received. Using the excellent
            <a href="https://github.com/MatthewMueller/cheerio">Cheerio</a> I then load in the template html and then manipulate
            it using simple jQuery-like functionality to add in a title and the content from the POST data from Draftin.</p>
          <p>Once completed, the amended file is then saved as a new file with the stated title then accessible at blog.grabeh.net/[title].
            Draftin also allows you to provide a location url in your response which is then captured by Draftin which is
            then displayed by your post.</p>
          <p>The whole basic Express server is below for the curious. As the documentation on Draftin notes, the URL used to
            post data to should be sufficiently obscure.</p>
          </code>
          </pre>
          var express = require('express') , fs = require('fs') , cheerio = require('cheerio') , app = express(); app.configure(function(){
          app.use(express.bodyParser()); app.use(app.router); }); app.post('/', function(req, res){ var payload = req.body.payload;
          var parsedResponse = JSON.parse(payload); var title = parsedResponse.name; var htitle = title.replace(/\s+/g, '-').toLowerCase();
          var parsedhtml = parsedResponse.content_html; fs.readFile('/usr/local/nginx/html/blog/template.html', function(err,
          data){ $ = cheerio.load(data); $('h3').text(title); $('#textbody').html(parsedhtml); var updatedhtml = $.html();
          fs.writeFile('/usr/local/nginx/html/blog/' + htitle + '.html', updatedhtml, function(err){ if (!err) { res.set('location',
          'http://blog.grabeh.net/' + htitle); res.send(); } }); }) }); app.listen(3010);

          </code>
          </pre>
          <p>I do need to resolve a few minor points like inserting a title in the head and also updating the index.html of
            the blog, but I think the above system creates a nice flow for automatically posting content to the blog from
            Draftin.
          </p>
          <p>The only issue now of course is to keep focused on writing in the first place.</p>
        </div>
      </div>
    </div>
    <div class="mb3 mt0-l mt3 pl4-l fl w-30-l w-100">
      <div class="bg-white f4 pa3 shadow-5">
        <ul class="pa0 ma0 list">
          <li class="pv1"><a class="underline link black" href="https://twitter.com/grabbeh"><i class="mr2 fa fa-twitter "aria-hidden="true"></i>Twitter</a></li>
          <li class="pv1"><a class="underline  link black " href="https://github.com/grabbeh"><i class="mr2 fa fa-github" aria-hidden="true"></i>GitHub</a></li>
          <li class="pv1"><a class="underline  link black " href="/about"><i class="mr2 fa fa-user" aria-hidden="true"></i>About</a></li>
        </ul>
      </div>
    </div>
  </div>
</body>
<script>
  var arr = [
    "bg-red",
    "bg-purple",
    "bg-light-purple",
    "bg-green",
    "bg-navy",
    "bg-dark-blue",
    "bg-blue",
    "bg-light-blue",
    "bg-lightest-blue",
    "bg-light-pink",
    "bg-light-yellow",
    "bg-light-red"]

      /* var color = arr[Math.floor(Math.random()*arr.length)]
      var el = document.getElementById("container")
      el.className = color*/

</script>

</html>