
<html>
<head>
<meta charset="utf-8">
<title>Blog - Digital Ocean VPS + Nginx + Express apps</title>
<script src="https://google-code-prettify.googlecode.com/svn/loader/run_prettify.js?skin=sunburst"></script>
<link href="http://fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="style.css">
</head>

<body>

<div id="container">
<div id="title">
<h3>Digital Ocean VPS + Nginx + Express apps</h3>
</div>
<div id="textbody"><p>I recently started investigating the murky (at least for me) world of VPSs. I was previously hosting a few pet projects on Nodejitsu but although their service is excellent, the nature of my projects didn&#39;t really warrant using the platform.</p><p>At the same time, I was interested in learning more about using linux commands and investigating how straightforward it was for a beginner to get Express apps running on a VPS and accessible via a specified subdomain.</p><p><a href="http://digitalocean.com">Digital Ocean</a> provides a basic option at $5 per month and I spun up an instance running Ubuntu 12.04 based in Amsterdam no less.</p><p>You&#39;ll access your VPS by using a SSH client. As I&#39;m on Windows I use <a href="http://www.chiark.greenend.org.uk/%7Esgtatham/putty/">PuTTY</a>. Through this you&#39;ll input your login details for the VPS and you should be able to start on the road to getting your Express app running.</p><p><a href="http://wiki.nginx.org/Main">Nginx</a> is an open source http/reverse proxy server software and is being increasingly used on the basis that it offers simplified but powerful functionality for running servers in comparison to Apache (as I understand it at least!).</p><p>The first steps was to get Nginx running. This was fairly straightforward and I followed the steps in <a href="http://www.packtpub.com/nginx-http-server/book">Nginx HTTP Server</a> by Clement Nedelcu. Nginx runs by using a central configuration file, but you can incorporate other conf files with the simple use of &#39;include&#39;. On my installation the conf files were located in the following folder /usr/local/nginx/conf/ on the VPS.</p><p>So following installation I had a basic http server up and running serving a index.html file at grabeh.net (adding a domain through Digital Ocean and updating the nameservers to point at the VPS was simple enough).</p><p><strong><em>Installing node.js and your Express app</em></strong></p><p>The next step was to identify how to get Express apps running on the VPS. Installing node.js itself was obviously key!</p><p>The most straightforward way I identified was the following:</p>
<ul>
<li>apt-get install python-software-properties</li><li>apt-add-repository ppa:chris-lea/node.js</li><li>apt-get update</li><li>apt-get install nodejs</li></ul>
<p>After this point I was able to type in &#39;node&#39; and get access to the REPL. Typing in 2 + 2 did indeed give me 4 which was a pleasure to see (particularly owing to my deficient maths skills). As a bonus, you&#39;ll also get npm for package control.</p><p>The next step was to get a small Express app running on the VPS. The easiest way I found was to git clone a basic app into the VPS. You can use the one <a href="http://github.com/Grabbeh/express-hello-world">here</a> on Github if you want. (Using apt-get install git-core will give you access to git commands).</p><p></p><p>Then simply &#39;npm install&#39; to install the Express dependency. After that &#39;node app&#39; should have the app running on port 3000.</p><p>As you will see using node app means the app is running in the foreground which means we cannot do anything else on the command line whilst the app is running. This simply will not do!</p><p>I recalled a while ago reading about Nodejitsu&#39;s Forever tool which allows you to set a node app running in the background. This <a href="http://blog.nodejitsu.com/keep-a-nodejs-server-up-with-forever">link</a> on Nodejitsu&#39;s site provides step-by-step instructions, however basically just use &#39;npm install forever -g&#39; and then in your app&#39;s directory you can use &#39;forever start app.js&#39; and your app will be running in the background. If you&#39;re planning on running multiple apps you may want to remain the app.js file to be more descriptive.</p><p>This is because &#39;forever list&#39; will specify the apps running and for me things got confusing when I was using app.js for all apps.</p><p><strong><em>Getting your Express app displaying on a subdomain</em></strong></p><p>The next step was to determine how to get the app to display via a subdomain on grabeh.net.</p><p>A brief visit to Stackoverflow showed the way, and it wasn&#39;t long before the Nginx &#39;proxy_pass&#39; and &#39;upstream&#39; directives were identified as being necessary via this <a href="http://stackoverflow.com/questions/5009324/node-js-nginx-and-now">Stackoverflow question</a>.</p><p>After some tinkering I used the following configuration file to specify port 3000 as the upstream location for the Express app, and then using proxy_pass and proxy_set_... to specify what should happen with requests to, in this case, helloworld.grabeh.net.</p>
<pre class="prettyprint">
worker_processes 1;
 
events {
  worker_connections 1024;
}
http {
 
    include       mime.types;
    default_type  application/octet-stream;
    sendfile      on;
    tcp_nopush    on;
 
# specify the location of the Express app you want to serve up
 
upstream helloworld {
  server localhost:3000;
}
 
# calls to www.grabeh.net will be rewritten to grabeh.net
 
server {
  listen 80;
    server_name www.grabeh.net *.grabeh.net;
    rewrite ^(.*) http://grabeh.net$1 permanent;
} 
 
# specify what will happen when a request to helloworld.[your domain] is made. 
# Here we are proxying the Express app through.
 
server {
  listen 80;
  server_name helloworld.grabeh.net;
  
  location / {
    try_files $uri @helloworld;
}
 
  location @helloworld {
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $proxy_host;
    proxy_set_header X-NginX-Proxy true;
    proxy_pass http://helloworld;
    }
}
 
# basic element where we're sending index.html for requests to grabeh.net/
server {
   listen 80; 
   server_name grabeh.net;
 
   location / {
    root html/home;
    index index.html index.htm;
    }  
    }
}
</pre>
<p>If you use this you&#39;ll obviously have to update the domain name &#39;grabeh.net&#39; to your own domain.</p><p>Testing your .conf before sending it live is important. If I&#39;m making any changes to nginx.conf I first use &#39;cp nginx.conf test.conf&#39; and make changes to test.conf rather than the live file. Testing the file is done by ./nginx -t -c [location of test.conf]. If tests pass, then using &#39;mv test.conf nginx.conf&#39; will switch in the new conf for the existing one.</p><p>After switching in the modified .conf file using &#39;./nginx -s reload&#39; should result in &#39;Hello World&#39; showing when you navigate to &#39;helloworld.[yourdomain].[tld].</p><p>Hopefully the above or at least parts of it are useful. It&#39;s always good for me to get thoughts down to help cement my understanding. I&#39;m still getting to grips with Nginx and whilst there was lots of good information on Digital Ocean&#39;s site and Stackoverflow of course, there didn&#39;t seem to be a full step-by-step guide to the entire process.</p></div>
</div>
</body>
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-43666889-1']);
  _gaq.push(['_setDomainName', 'grabeh.net']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script></html>
